---
- name: Import Zabbix Template – CDR (Mock Mode Supported)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    zabbix_url: "{{ lookup('env','ZABBIX_API_URL') }}"
    zabbix_user: "{{ lookup('env','ZABBIX_USERNAME') }}"
    zabbix_password: "{{ lookup('env','ZABBIX_PASSWORD') }}"
    template_file: "{{ template_file }}"

  tasks:

    - name: Check if mock mode is enabled
      debug:
        msg: "Mock mode detected — skipping Zabbix API calls."
      when: zabbix_url == 'mock'

    - name: Exit early in mock mode (success)
      meta: end_play
      when: zabbix_url == 'mock'

    #  Real API workflow (only runs if real URL is set) -------------------------

    - name: Read XML template
      slurp:
        src: "{{ template_file }}"
      register: xml_file
      when: zabbix_url != 'mock'

    - name: Convert XML to string
      set_fact:
        xml_content: "{{ xml_file.content | b64decode }}"
      when: zabbix_url != 'mock'

    - name: Get auth token
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "user.login"
          params:
            username: "{{ zabbix_user }}"
            password: "{{ zabbix_password }}"
          id: 1
        return_content: yes
      register: login_reply
      when: zabbix_url != 'mock'

    - name: Extract auth token
      set_fact:
        auth_token: "{{ login_reply.json.result }}"
      when: zabbix_url != 'mock'

    - name: Import template via Zabbix API
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "configuration.import"
          params:
            format: "xml"
            rules:
              templates:
                createMissing: true
                updateExisting: true
            source: "{{ xml_content }}"
          auth: "{{ auth_token }}"
          id: 2
        return_content: yes
      register: import_result
      when: zabbix_url != 'mock'

    - name: Print result
      debug:
        msg: "Template import completed successfully (mock or real)."
