---
- name: Import Zabbix Template – CDR (Mock Mode Supported)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    raw_url: "{{ lookup('env','ZABBIX_API_URL') | default('') }}"
    zabbix_url: "{{ raw_url | trim }}"
    is_mock: >-
      {{ 
        (zabbix_url | lower == 'mock')
        or (zabbix_url == '')
        or ('api_jsonrpc.php' not in zabbix_url)
      }}
    template_file: "{{ template_file }}"
    zabbix_user: "{{ lookup('env','ZABBIX_USERNAME') }}"
    zabbix_password: "{{ lookup('env','ZABBIX_PASSWORD') }}"

  tasks:

    - name: Show mode
      debug:
        msg: "MOCK MODE ENABLED — Skipping API calls."
      when: is_mock

    - name: Exit early in mock mode
      meta: end_play
      when: is_mock

    # -------------------- REAL MODE BELOW --------------------

    - name: Read XML template
      slurp:
        src: "{{ template_file }}"
      register: xml_file

    - name: Convert XML to string
      set_fact:
        xml_content: "{{ xml_file.content | b64decode }}"

    - name: Get auth token
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "user.login"
          params:
            username: "{{ zabbix_user }}"
            password: "{{ zabbix_password }}"
          id: 1
        return_content: yes
      register: login_reply

    - name: Extract token
      set_fact:
        auth_token: "{{ login_reply.json.result }}"

    - name: Import template via Zabbix API
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "configuration.import"
          params:
            format: "xml"
            rules:
              templates:
                createMissing: true
                updateExisting: true
            source: "{{ xml_content }}"
          auth: "{{ auth_token }}"
          id: 2
        return_content: yes
      register: import_result

    - name: Print import result
      debug:
        var: import_result.json
