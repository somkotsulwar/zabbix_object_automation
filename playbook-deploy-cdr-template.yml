---
- name: Import Zabbix Template â€“ CDR (API Method)
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    zabbix_url: "{{ lookup('env','ZABBIX_API_URL') }}"
    zabbix_user: "{{ lookup('env','ZABBIX_USERNAME') }}"
    zabbix_password: "{{ lookup('env','ZABBIX_PASSWORD') }}"
    template_file: "{{ template_file }}"

  tasks:

    - name: Read XML template
      slurp:
        src: "{{ template_file }}"
      register: xml_file

    - name: Convert XML to string
      set_fact:
        xml_content: "{{ xml_file.content | b64decode }}"

    - name: Get auth token
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "user.login"
          params:
            username: "{{ zabbix_user }}"
            password: "{{ zabbix_password }}"
          id: 1
        return_content: yes
      register: login_reply

    - name: Extract token
      set_fact:
        auth_token: "{{ login_reply.json.result }}"

    - name: Import template into Zabbix
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "configuration.import"
          params:
            format: "xml"
            rules:
              templates:
                createMissing: true
                updateExisting: true
            source: "{{ xml_content }}"
          auth: "{{ auth_token }}"
          id: 2
        return_content: yes
      register: import_result

    - name: Show result
      debug:
        var: import_result.json
